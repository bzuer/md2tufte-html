---
import { readFile, readdir } from "node:fs/promises";
import path from "node:path";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { renderMarkdown } from "../../lib/markdown.js";

export const prerender = true;

export async function getStaticPaths() {
  const contentDir = path.resolve(process.cwd(), "content");

  let files = [];
  try {
    files = await readdir(contentDir);
  } catch (error) {
    return [];
  }

  return files
    .filter((name) => name.endsWith(".md") && name !== "index.md")
    .map((name) => {
      const slug = name.slice(0, -3);
      return { params: { slug }, props: { filename: name } };
    });
}

const { slug } = Astro.params;
const { filename } = Astro.props;
const contentDir = path.resolve(process.cwd(), "content");
const markdownPath = path.join(contentDir, filename);
const markdown = await readFile(markdownPath, "utf-8");
const html = await renderMarkdown(markdown);
const title = slug.charAt(0).toUpperCase() + slug.slice(1);
---

<BaseLayout title={title}>
  <Fragment set:html={html} />
</BaseLayout>
